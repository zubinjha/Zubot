# Zubot Tools

This document defines the initial tools scaffold in `src/zubot/tools/`.

## Kernel Modules
- `src/zubot/tools/kernel/filesystem.py`
  - `read_file(path)`
  - `list_dir(path=".")`
  - `path_exists(path)`
  - `stat_path(path)`
  - `write_file(path, content, ...)`
  - `append_file(path, content, ...)`
  - Enforces filesystem policy through `src/zubot/core/path_policy.py`.
- `src/zubot/tools/kernel/location.py`
  - `get_location()`
  - Returns normalized location fields (`lat`, `lon`, `city`, `region`, `country`, `timezone`, `source`).
- `src/zubot/tools/kernel/time.py`
  - `get_current_time(location=None)`
  - Returns:
    - `iso_utc` from system UTC clock
    - `iso_local` converted using location/config timezone when available
    - `human_utc` and `human_local` for display-friendly timestamps
    - `timezone` and `timezone_source` for fallback transparency
- `src/zubot/tools/kernel/web_search.py`
  - `web_search(query, count=5, country="US", search_lang="en")`
  - Uses Brave Search API and returns normalized web results (`title`, `url`, `description`, `age`, `language`).
  - Returns `source` values:
    - `brave_api`
    - `config_missing`
    - `brave_api_error`
- `src/zubot/tools/kernel/web_fetch.py`
  - `fetch_url(url)`
  - Fetches an `http/https` URL and extracts readable text.
  - Handles both `text/html` and `text/plain`.
  - Returns `source` values:
    - `web_fetch`
    - `web_fetch_error`
- `src/zubot/tools/kernel/hasdata_indeed.py`
  - `get_indeed_jobs(keyword, location)`
  - `get_indeed_job_detail(url)`
  - Uses HasData API endpoints for Indeed listing/detail retrieval.
  - Listing tool behavior is fixed internally to:
    - `domain = www.indeed.com`
    - `sort = date`
  - Returns normalized payloads with:
    - `provider` (`hasdata`)
    - `source` (`hasdata_indeed_listing`, `hasdata_indeed_job`, or `*_error`)
    - `queue` metadata (`group`, `wait_sec`, `attempt`)
    - `queue_stats` (`pending`, `calls_*`, `wait_sec_*`, `last_error`)
    - `error` when request/parsing fails
  - All HasData calls are serialized through provider queue group `hasdata` (concurrency=1).
- `src/zubot/tools/kernel/google_auth.py` (unregistered helper)
  - `get_google_access_token(force_refresh=False)`
  - Reads OAuth config from `tool_profiles.user_specific.google_oauth`.
  - Uses refresh token flow to mint access tokens on demand.
  - Persists token state to `tool_profiles.user_specific.google_oauth.token_path`.
  - Returns normalized payloads with:
    - success source: `google_oauth_cache` or `google_oauth_refreshed`
    - failure source: `google_oauth_error`
    - `error_code` for config/refresh failures
- `src/zubot/tools/kernel/google_sheets_job_apps.py` (unregistered helper)
  - `list_job_app_rows(start_date=None, end_date=None)`
  - `append_job_app_row(row)`
  - `delete_job_app_row_by_key(job_key)`
  - Reads spreadsheet id from:
    - `tool_profiles.user_specific.google_drive.job_application_spreadsheet_id`
  - Uses tab name `Job Applications` and fixed column schema:
    - `JobKey`, `Company`, `Job Title`, `Location`, `Date Found`, `Date Applied`, `Status`, `Pay Range`, `Job Link`, `Source`, `Cover Letter`, `Notes`
  - Canonical sheet/db schema contract is centralized in:
    - `src/zubot/core/job_applications_schema.py`
  - Local SQLite mirror table:
    - `job_applications` in `memory/central/zubot_core.db`
    - DB columns align to sheet columns by semantic field (`job_key` <-> `JobKey`, etc.)
  - Date handling:
    - accepts `YYYY-MM-DD` and `MM/DD/YYYY`
    - normalizes to `YYYY-MM-DD` for comparisons/writes
    - list filtering applies inclusive bounds to `Date Found`
  - Append behavior:
    - validates required row fields
    - validates `Status` against allowed values:
      - `Recommend Apply`
      - `Recommend Maybe`
      - `Applied`
      - `Interviewing`
      - `Offer`
      - `Rejected`
      - `Closed`
    - enforces JobKey dedupe by checking existing `JobKey` values before append
    - writes to the earliest available row where both `JobKey` and `Job Title` are empty
  - Delete behavior:
    - looks up `JobKey` in `A2:A`
    - deletes the matching row via Sheets `batchUpdate` row delete
    - fails safely when key is missing or duplicated
- `src/zubot/tools/kernel/google_drive_docs.py` (unregistered helper)
  - `create_local_docx(filename, title=None, paragraphs, output_dir="outputs/cover_letters")`
  - `upload_file_to_google_drive(local_path, destination_path="Job Applications/Cover Letters", filename=None)`
  - `create_and_upload_docx(filename, title=None, paragraphs, output_dir="outputs/cover_letters", destination_path="Job Applications/Cover Letters")`
  - DOCX behavior:
    - generates `.docx` files using `python-docx`
    - writes local output under repo-relative paths (default `outputs/cover_letters`)
    - validates non-empty paragraph content
  - Drive upload behavior:
    - prefers configured `cover_letters_folder_id` when destination is the default cover-letter path
    - otherwise resolves folder paths by name (for example `Job Applications/Cover Letters`) and auto-creates missing folders
    - uploads via Drive multipart upload API
    - checks name conflict in destination folder and appends timestamp suffix (`-YYYYMMDD-HHMMSS`) when needed
    - returns normalized upload metadata (`drive_file_id`, `drive_file_name`, `destination_folder_id`, `web_view_link`)
- `src/zubot/tools/kernel/weather.py`
  - `get_weather(location=None)`
  - `get_future_weather(location=None, horizon="daily", hours=24, days=7)`
  - `get_week_outlook(location=None)` for normalized daily outlook rows
  - `get_weather_24hr(location=None)` for normalized 24-hour rows
  - `get_today_weather(location=None)` for compact today summary
  - Uses Open-Meteo with location coordinates from `get_location()`.
  - Returns normalized payloads with:
    - `provider` (`open_meteo`)
    - `source` (`open_meteo`, `location_unresolved`, or `open_meteo_error`)
    - `error` when request/parsing fails

## Notes
- These are contracts-first stubs, not production integrations.
- External API/provider wiring will be added after config and context-loop foundations.
- Tools should return normalized dictionaries to keep prompt assembly stable.
- Tools should retrieve settings through `src/zubot/core/config_loader.py` (for example, timezone and home location).
- Keep personal baseline tools in `src/zubot/tools/kernel/` to avoid clutter as more specialized tool groups are added.
- Data-aware helpers live in `src/zubot/tools/data/`:
  - `read_json(path)`
  - `write_json(path, obj, ...)`
  - `search_text(query, ...)`
- Weather config lives in `config/config.json` under `weather`:
  - `base_url`
  - `temperature_unit`
  - `wind_speed_unit`
  - `precipitation_unit`
  - `timeout_sec`
- Filesystem config lives in `config/config.json` under `filesystem`:
  - `default_access`
  - `allow_read`
  - `allow_write`
  - `deny`
- Web search config lives in `config/config.json` under `web_search`:
  - `provider` (`brave`)
  - `base_url`
  - `brave_api_key`
  - `timeout_sec`
- Web fetch config lives in `config/config.json` under `web_fetch`:
  - `timeout_sec`
  - `max_chars`
  - `user_agent`
- HasData config lives in `config/config.json` under `tool_profiles.user_specific.has_data`:
  - `api_key`
  - `base_url` (default `https://api.hasdata.com`)
  - `timeout_sec`
  - `queue_min_interval_sec`
  - `queue_jitter_sec`
  - `queue_max_retries`
  - `queue_retry_backoff_sec`
- Google auth/drive config for Google helper modules lives under:
  - `tool_profiles.user_specific.google_oauth`
  - `tool_profiles.user_specific.google_drive`
  - Google Drive DOCX helpers additionally use:
    - `tool_profiles.user_specific.google_drive.default_upload_path`
    - `tool_profiles.user_specific.google_drive.cover_letters_folder_id`
    - `tool_profiles.user_specific.google_drive.timeout_sec`

## Google Token Lifecycle
- Token path is loaded from:
  - `tool_profiles.user_specific.google_oauth.token_path`
- Runtime behavior:
  - use cached token when present and not near expiry
  - refresh on demand when token is missing, expired, or forced
  - write refreshed token state atomically to avoid partial-file corruption
- Failure behavior:
  - invalid/expired refresh token surfaces a structured `google_oauth_error` payload
  - token response shape errors surface `google_oauth_error` with `error_code`
- Scope requirement:
  - Drive upload helpers require a write-capable Drive scope such as `https://www.googleapis.com/auth/drive.file`
  - changing scopes may require refreshing/reconsenting OAuth credentials before uploads work
- Secret handling:
  - credentials and refresh tokens are read from config/token file but not logged in tool outputs/docs.

## Registry

Primary module:
- `src/zubot/core/tool_registry.py`
- user-specific registry layer: `src/zubot/core/tool_registry_user.py`

Behavior:
- core registry composes:
  - base kernel/data/orchestration tools in `tool_registry.py`
  - user-specific tools in `tool_registry_user.py`
- registry exposes metadata as a machine-readable tool contract for model calls
- runtime dispatch should go through `invoke_tool(name, **kwargs)` instead of importing tool handlers ad hoc
- weather/time tools auto-inject `get_location()` when `location` is omitted or explicitly `null`
- task orchestration is queue-centric (`enqueue_task`, `enqueue_agentic_task`, `kill_task_run`, `list_task_runs`) instead of worker-centric spawning.
- waiting-run orchestration is supported (`list_waiting_runs`, `resume_task_run`).
- central SQL access is routed through serialized queue tool (`query_central_db`) for concurrency safety.
- task atomic state helpers are exposed through tools:
  - `upsert_task_state`
  - `get_task_state`
  - `mark_task_item_seen`
  - `has_task_item_seen`

LLM integration:
- `app/chat_logic.py` builds OpenAI-style tool schemas from registry metadata each turn
- model tool calls are parsed and executed through `invoke_tool(...)`
- tool outputs are injected back as `role="tool"` messages before final response generation

Current registered tools:
- Orchestration:
  - `enqueue_task`
  - `enqueue_agentic_task`
  - `kill_task_run`
  - `list_task_runs`
  - `list_waiting_runs`
  - `resume_task_run`
  - `get_task_agent_checkin`
  - `query_central_db`
  - `upsert_task_state`
  - `get_task_state`
  - `mark_task_item_seen`
  - `has_task_item_seen`
- Kernel:
  - `get_location`
  - `get_current_time`
  - `get_weather`
  - `get_future_weather`
  - `get_today_weather`
  - `get_weather_24hr`
  - `get_week_outlook`
  - `read_file`
  - `list_dir`
  - `path_exists`
  - `stat_path`
  - `write_file`
  - `append_file`
  - `web_search`
  - `fetch_url`
  - `get_indeed_jobs`
  - `get_indeed_job_detail`
- Data:
  - `read_json`
  - `write_json`
  - `search_text`

## Chat Tool Routing

Primary module:
- `app/chat_logic.py`

Behavior rules:
- no keyword-based direct routing
- every chat request uses the LLM + tool loop
- model sees registry-backed tool schemas each turn and chooses tool calls
- runtime executes selected tools through `invoke_tool(...)` and feeds outputs back before final answer
